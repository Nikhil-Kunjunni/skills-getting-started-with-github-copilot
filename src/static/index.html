<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mergington High School Activities</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header>
      <h1>Mergington High School</h1>
      <h2>Extracurricular Activities</h2>
    </header>

    <main>
      <section id="activities-container">
        <h3>Available Activities</h3>
        <div id="activities-list">
          <!-- Activities will be loaded here -->
          <p>Loading activities...</p>
        </div>
      </section>

      <section id="signup-container">
        <h3>Sign Up for an Activity</h3>
        <form id="signup-form">
          <div class="form-group">
            <label for="email">Student Email:</label>
            <input type="email" id="email" required placeholder="your-email@mergington.edu" />
          </div>
          <div class="form-group">
            <label for="activity">Select Activity:</label>
            <select id="activity" required>
              <option value="">-- Select an activity --</option>
              <!-- Activity options will be loaded here -->
            </select>
          </div>
          <button type="submit">Sign Up</button>
        </form>
        <div id="message" class="hidden"></div>
      </section>
    </main>

    <footer>
      <p>&copy; 2023 Mergington High School</p>
    </footer>

    <script>
      // Fetch activities and render UI
      async function loadActivities() {
        const resp = await fetch('/activities');
        if (!resp.ok) {
          showMessage('Unable to load activities', 'error');
          return;
        }
        const activities = await resp.json();
        renderActivities(activities);
      }

      function renderActivities(activities) {
        const list = document.getElementById('activities-list');
        const select = document.getElementById('activity');
        list.innerHTML = '';
        // Clear existing options except placeholder
        select.querySelectorAll('option.activity-option')?.forEach(o => o.remove());

        for (const [name, info] of Object.entries(activities)) {
          // Activity card
          const card = document.createElement('div');
          card.className = 'activity-card';

          const title = document.createElement('h4');
          title.textContent = name;
          card.appendChild(title);

          const desc = document.createElement('p');
          desc.textContent = info.description;
          card.appendChild(desc);

          const sched = document.createElement('p');
          sched.innerHTML = '<strong>Schedule:</strong> ' + info.schedule;
          card.appendChild(sched);

          const spots = document.createElement('p');
          const remaining = Math.max(0, info.max_participants - (info.participants?.length || 0));
          spots.innerHTML = '<strong>Spots left:</strong> ' + remaining + ' / ' + info.max_participants;
          card.appendChild(spots);

          // Participants section
          const participantsWrap = document.createElement('div');
          participantsWrap.className = 'participants';

          const header = document.createElement('div');
          header.className = 'participants-header';
          const hdrTitle = document.createElement('span');
          hdrTitle.textContent = 'Participants';
          const hdrCount = document.createElement('span');
          hdrCount.className = 'participants-count';
          hdrCount.textContent = (info.participants?.length || 0);
          header.appendChild(hdrTitle);
          header.appendChild(hdrCount);

          participantsWrap.appendChild(header);

          if (info.participants && info.participants.length > 0) {
            const ul = document.createElement('ul');
            ul.className = 'participants-list';
            for (const p of info.participants) {
              const li = document.createElement('li');
              li.textContent = p;
              ul.appendChild(li);
            }
            participantsWrap.appendChild(ul);
          } else {
            const none = document.createElement('div');
            none.className = 'no-participants';
            none.textContent = 'No participants yet.';
            participantsWrap.appendChild(none);
          }

          card.appendChild(participantsWrap);
          list.appendChild(card);

          // Add option to select
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          opt.className = 'activity-option';
          select.appendChild(opt);
        }
      }

      // Message helper
      function showMessage(text, type='info') {
        const msg = document.getElementById('message');
        msg.className = 'message ' + (type || 'info');
        msg.textContent = text;
        msg.classList.remove('hidden');
      }

      // Handle signup form
      document.getElementById('signup-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value.trim();
        const activity = document.getElementById('activity').value;
        if (!email || !activity) {
          showMessage('Please provide an email and select an activity.', 'error');
          return;
        }
        try {
          const url = `/activities/${encodeURIComponent(activity)}/signup?email=${encodeURIComponent(email)}`;
          const resp = await fetch(url, { method: 'POST' });
          if (!resp.ok) {
            const err = await resp.json().catch(()=>({detail: resp.statusText}));
            showMessage(err.detail || 'Signup failed', 'error');
            return;
          }
          const data = await resp.json().catch(()=>({message: 'Signed up'}));
          showMessage(data.message || 'Signed up successfully', 'success');
          // Refresh activities to show updated participants
          await loadActivities();
          // clear email field
          document.getElementById('email').value = '';
        } catch (err) {
          showMessage('Network error while signing up', 'error');
        }
      });

      // initial load
      document.addEventListener('DOMContentLoaded', loadActivities);
    </script>
  </body>
</html>
